---
title: "Data wrangling for register studies"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Data wrangling for register studies}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Install and load necessary libraries for this example

```{r, warning=FALSE, message=FALSE}
library(regstudies) 
library(tidyverse)
library(vroom)
library(lubridate)
```


We need to also create a new help variable `icd` which determines if code is ICD-9, ICD-10 or some other format by year:

```{r}
d <- left_join(sample_cohort,sample_regdata)

```

# Data wrangling for register data sets

### Example data set

The regstudies package also provides useful tools for modifying and filtering the register data sets. Typically in register studies the data consists of events, which are stored in data as time stamps. In our example data set the time stamps are date of hospital visits. Also, in register studies the data are commonly studied with respect to index date, which is a date of interest that can vary by individuals.

Our example data is simulated data that represents a postal questionnaire survey study which has been extended to register data. There are two data sets, the `sample_cohort` is holding the study group, and `sample_regdata` holds the hospital visits for the study group members.

More precisely, the `sample_cohort` lists the individual id study numbers as `id` for whom the register data has been collected. It also list the `postingdate` holding the date of submitting the postal questionnaire.
The `sample_regdata` contains also variable `id` which is necessary to be able to link the data sets. The `sample_regdata` also contains variables holding the diagnosis codes at `CODE1` and times of hospital admission `adm_date` and hospital discharge `disc_date`.

```{r}
head(sample_cohort)
```

```{r}
head(sample_regdata)
```
# Filtering

## Filtering by dates

Filter dataset with either `adm_date` or `disc_date` within two years around `postingdate`

```{r}
filtered_d <- d %>% 
  regstudies::filter_date_range(indexdate=postingdate, 
                          range=years(2),
                          adm_date,
                          disc_date) 
head(filtered_d)
```

## Filtering by date intervals

Filter data set with occurrences of hospital visits. If person has been in hospital during the time period two years prior `postingdate` then those events are included.


```{r}
filtered_d <- d %>% 
  filter_date_interval(indexdate = postingdate,
                       time_before=years(2),
                       admission_date=adm_date,
                       discharge_date=disc_date)
head(filtered_d)
```

### Complex filtering

```{r}
elixh_d <- d %>% 
  classify_elixhauser(CODE1)
head(elixh_d)
```